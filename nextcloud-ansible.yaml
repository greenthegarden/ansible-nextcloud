---

# Source: https://dev.to/kuwv/why-i-use-ansible-over-docker-compose-edg

- name: Run Nextcloud
  hosts: localhost

  tasks:

    - name: Setup network for Nextcloud
      docker_network:
        name: nextcloud-net
        state: "{{ sso_network_state | default('present') }}"

    - name: Setup volume for Postgres
      docker_volume:
        name: postgres-data
        state: "{{ sso_volume_state | default('present') }}"

    - name: Setup volume for Nextcloud
      docker_volume:
        name: nextcloud-data
        state: "{{ sso_volume_state | default('present') }}"

    - name: Check if Nextcloud DB is running
      docker_container_info:
        name: nextcloud-db
      register: nextcloud_db_state

    - block:
        - name: Start Nextcloud DB
          docker_container:
            name: nextcloud-db
            image: postgres
            volumes:
              - postgres-data:/var/lib/postresql/data
            networks_cli_compatible: true
            networks:
              - name: nextcloud-net
            ports:
              - "5432:5432"
            env:
              POSTGRES_DB: nextcloud
              POSTGRES_USER: nextcloud
              POSTGRES_PASSWORD: nextcloud
          register: nextcloud_db_register

      #   - name: Wait for nextcloud DB to accept connections
      #     wait_for:
      #       host: "{{ nextcloud_db_register['ansible_facts']\
      #         ['docker_container']\
      #         ['NetworkSettings']\
      #         ['Networks']\
      #         ['nextcloud-net']\
      #         ['IPAddress'] }}"
      #       port: 5432
      #       state: started
      #       connect_timeout: 1
      #       timeout: 30
      #     register: nextcloud_db_running
      #     until: nextcloud_db_running is success
      #     retries: 10
      # when: not nextcloud_db_state.exists

    - name: Check if Nextcloud is running
      docker_container_info:
        name: nextcloud
      register: nextcloud_state

    - block:
        - name: Start nextcloud
          docker_container:
            name: nextcloud
            image: nextcloud
            networks_cli_compatible: true
            networks:
              - name: nextcloud-net
                links:
                  - nextcloud-db
              # - name: api-net
              #   links:
              #     - webapp
              #     - kong
            ports:
              - '8081:80'
            volumes:
              - nextcloud:/var/www/html
            env:
              POSTGRES_HOST: nextcloud-db
              POSTGRES_DB: nextcloud
              POSTGRES_USER: nextcloud
              POSTGRES_PASSWORD: nextcloud
              NEXTCLOUD_ADMIN_PASSWORD: nextcloud
              NEXTCLOUD_ADMIN_USER: nextcloud
          register: nextcloud_register

        - name: Wait for nextcloud to accept connections
          wait_for:
            host: "{{ nextcloud_register['ansible_facts']\
              ['docker_container']\
              ['NetworkSettings']\
              ['Networks']\
              ['nextcloud-net']\
              ['IPAddress'] }}"
            port: 8080
            state: started
            connect_timeout: 1
            timeout: 30
          register: nextcloud_running
          until: nextcloud_running is success
          retries: 10
      when: not nextcloud_state.exists
